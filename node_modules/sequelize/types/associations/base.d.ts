// src/models/index.js
const sequelize = require('../config/db')

// Import semua model
const User                  = require('./User')
const Category              = require('./Category')
const Course                = require('./Course')
const Session               = require('./Session')
const Lesson                = require('./Lesson')
const Quiz                  = require('./Quiz')
const QuizOption            = require('./QuizOption')
const Assignment            = require('./Assignment')
const AssignmentSubmission  = require('./AssignmentSubmission')
const Enrollment            = require('./Enrollment')
const Payment               = require('./Payment')
const Notification          = require('./Notification')
const Message               = require('./Message')

// Kumpulkan semua model dalam sebuah object
const models = {
  User,
  Category,
  Course,
  Session,
  Lesson,
  Quiz,
  QuizOption,
  Assignment,
  AssignmentSubmission,
  Enrollment,
  Payment,
  Notification,
  Message,
}

// Definisikan relasi lewat method associate() pada setiap model, jika ada
Object.values(models).forEach(model => {
  if (typeof model.associate === 'function') {
    model.associate(models)
  }
})

// Beberapa relasi manual (jika ada yang belum didefinisikan di associate)
Category.hasMany(Course,   { foreignKey: 'category_id', as: 'courses' })
Course.belongsTo(Category, { foreignKey: 'category_id', as: 'Category' })

Course.hasMany(Session,    { foreignKey: 'course_id',   as: 'sessions' })
Session.belongsTo(Course,  { foreignKey: 'course_id',   as: 'course' })

Session.hasMany(Lesson,    { foreignKey: 'session_id',  as: 'lessons' })
Lesson.belongsTo(Session,  { foreignKey: 'session_id',  as: 'session' })

Lesson.hasMany(Quiz,       { foreignKey: 'lesson_id',   as: 'quizzes' })
Quiz.belongsTo(Lesson,     { foreignKey: 'lesson_id',   as: 'lesson' })

Quiz.hasMany(QuizOption,   { foreignKey: 'quiz_id',     as: 'options' })
QuizOption.belongsTo(Quiz, { foreignKey: 'quiz_id',     as: 'quiz' })

Course.hasMany(Assignment,           { foreignKey: 'course_id',  as: 'assignments' })
Assignment.belongsTo(Course,         { foreignKey: 'course_id',  as: 'course' })
Assignment.hasMany(AssignmentSubmission, { foreignKey: 'assignment_id', as: 'submissions' })
AssignmentSubmission.belongsTo(Assignment, { foreignKey: 'assignment_id', as: 'assignment' })
User.hasMany(AssignmentSubmission,   { foreignKey: 'user_id',    as: 'submissions' })
AssignmentSubmission.belongsTo(User, { foreignKey: 'user_id',    as: 'student' })

User.hasMany(Enrollment,     { foreignKey: 'user_id',    as: 'enrollments' })
Enrollment.belongsTo(User,   { foreignKey: 'user_id',    as: 'student' })
Course.hasMany(Enrollment,   { foreignKey: 'course_id',  as: 'enrollments' })
Enrollment.belongsTo(Course, { foreignKey: 'course_id',  as: 'course' })

User.hasMany(Payment,        { foreignKey: 'user_id',    as: 'payments' })
Payment.belongsTo(User,      { foreignKey: 'user_id',    as: 'payer' })
Course.hasMany(Payment,      { foreignKey: 'course_id',  as: 'payments' })
Payment.belongsTo(Course,    { foreignKey: 'course_id',  as: 'course' })

User.hasMany(Notification,   { foreignKey: 'user_id',    as: 'notifications' })
Notification.belongsTo(User, { foreignKey: 'user_id',    as: 'user' })

User.hasMany(Message,        { foreignKey: 'sender_id',   as: 'SentMessages' })
User.hasMany(Message,        { foreignKey: 'receiver_id', as: 'ReceivedMessages' })
Message.belongsTo(User,      { foreignKey: 'sender_id',   as: 'Sender' })
Message.belongsTo(User,      { foreignKey: 'receiver_id', as: 'Receiver' })
Course.hasMany(Message,      { foreignKey: 'course_id',   as: 'messages' })
Message.belongsTo(Course,    { foreignKey: 'course_id',   as: 'course' })

module.exports = {
  sequelize,
  ...models
}
